<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tarmeaz Academy - Home</title>
    <link rel="icon" type="image/png" href="tarmeaz_academy-removebg-preview.png" />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Google Fonts: Tajawal -->
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css?v=2.0" />
  </head>
  <body>
    <!-- Navbar will be loaded here -->

    <!-- Posts Section Start -->
    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯ -->
    <div class="container" style="max-width: 600px; margin-bottom: 32px">
      <form id="add-post-form" class="card p-3 mb-4 shadow-sm">
        <div class="mb-2">
          <input
            type="text"
            class="form-control mb-2"
            id="new-post-title"
            placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±"
            required
          />
          <textarea
            class="form-control mb-2"
            id="new-post-body"
            rows="3"
            placeholder="Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙƒØªØ¨ØŸ"
            style="resize: none"
            required
          ></textarea>
          <input
            type="file"
            class="form-control"
            id="new-post-image"
            accept="image/*"
          />
        </div>
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">Ù†Ø´Ø±</button>
        </div>
      </form>
    </div>
    <div id="post-card-id" class="container mt-5" style="max-width: 600px">
      <div class="post-card">
        <!-- <div class="d-flex align-items-center mb-2">
          <img
            src="https://randomuser.me/api/portraits/men/32.jpg"
            class="rounded-circle me-2"
            style="width: 36px; height: 36px"
            alt="Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯"
            onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'"
          />

          <span class="post-author">Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯</span>
          <span class="post-date ms-2">Ù‚Ø¨Ù„ Ø¯Ù‚ÙŠÙ‚Ø©</span>
        </div>
        <div>Ù‡Ø°Ø§ Ø£ÙˆÙ„ Ø¨ÙˆØ³Øª ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹! ğŸš€</div>
        <div class="tags mb-2">
          <span class="badge bg-primary me-1">#ØªØ¬Ø±ÙŠØ¨</span>
          <span class="badge bg-primary me-1">#Ù…ÙˆÙ‚Ø¹</span>
        </div>
        <img
          src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80"
          class="post-image"
          alt="post image"
        />
        <span class="comments-toggle" data-comments="0">2 ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
        <div class="comments-section">
          <div class="comment">
            <span class="comment-author">Ø³Ø§Ø±Ø©:</span> Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹ ğŸ‘
          </div>
          <div class="comment">
            <span class="comment-author">Ø®Ø§Ù„Ø¯:</span> Ù…ØªØ­Ù…Ø³ Ø£Ø´ÙˆÙ Ø§Ù„Ù…Ø²ÙŠØ¯!
          </div>
          <form class="add-comment">
            <input type="text" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚..." disabled />
            <button type="submit" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
          </form>
        </div> -->
      </div>
    </div>

    <div class="modal fade" id="editPostModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="edit-post-form">
            <div class="modal-header">
              <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙˆØ³Øª</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="edit-post-title" class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-post-title"
                  rows="4"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-post-body" class="form-label">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                <textarea
                  class="form-control"
                  id="edit-post-body"
                  rows="4"
                  style="resize: none"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="edit-post-image" class="form-label">Ø§Ù„ØµÙˆØ±Ø©</label>
                <input
                  type="file"
                  class="form-control"
                  id="edit-post-image"
                  rows="4"
                  style="resize: none"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Ø¥Ù„ØºØ§Ø¡
              </button>
              <button type="submit" class="btn btn-primary">
                Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ù…Ø®ØµØµØ© -->
    <div id="customDeleteModal" class="custom-modal">
      <div class="custom-modal-content">
        <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ</p>
        <button id="confirmDeleteBtn" class="custom-btn confirm">ØªØ£ÙƒÙŠØ¯</button>
        <button id="cancelDeleteBtn" class="custom-btn cancel">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>

    <script>
      let currentPage = 1;
      let totalPages = 1; // Ø³Ù†Ø­Ø³Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ù€ API
      const limit = 5; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙÙŠ ÙƒÙ„ ØµÙØ­Ø©
      const token = localStorage.getItem("token");
      let deleteEditingPostId = null;
      // ========= INFINITE SCROLL ========== //
      window.addEventListener("scroll", function () {
        const endOfPage =
          window.innerHeight + window.pageYOffset >= document.body.offsetHeight;
        if (endOfPage && currentPage < totalPages) {
          currentPage = currentPage + 1;
          GetPosts(currentPage, true); // append = true
        }
      });
      // ========= INFINITE SCROLL ========== //

      // ================== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª Ù…Ù† Ø§Ù„Ù€ API ==================
      function GetPosts(page = 1, append = false) {
        toggelLoading(true);
        axios
          .get(
            `https://tarmeezacademy.com/api/v1/posts?limit=${limit}&page=${page}`
          )
          .then(function (response) {
            let posts = response.data.data;
            totalPages = response.data.meta.last_page; // Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ Ù…Ù† Ø§Ù„Ù€ API
            SetPosts(posts, append);
            toggelLoading(false);
          })
          .catch(function (error) {
            console.log(error);
          });
      }

      // ================== Ù†Ù‡Ø§ÙŠØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª ==================

      // ================== Ø±Ø³Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª ==================
      function SetPosts(posts, append = false) {
        let postsHTML = "";
        for (const post of posts) {
          // ÙØ­Øµ Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ·ÙˆÙŠØ±
          if (post.image && typeof post.image !== "string") {
            console.log(
              "ØµÙˆØ±Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©:",
              post.image,
              "Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:",
              typeof post.image
            );
          }
          let tagsHTML = "";
          if (post.tags && post.tags.length > 0) {
            for (let i = 0; i < post.tags.length; i++) {
              tagsHTML += `<span class="badge bg-primary me-1">#${post.tags[i].name}</span>`;
            }
          }
          let user = JSON.parse(localStorage.getItem("user"));
          let userId = null;
          if (user) {
            userId = user.id;
          }
          let isMyPost = user != null && post.author.id === userId;
          let buttonContent = ``;

          if (isMyPost) {
            buttonContent = `
                <button class="btn btn-outline-danger btn-sm edit-post-btn"
                  data-post-id="${post.id}"
                  onclick="deleatPostClicked(event, ${post.id})"
                  style="position:absolute; top:16px; right:71px; z-index:2;">
                  Ø­Ø°Ù
                </button>
                <button class="btn btn-outline-primary btn-sm edit-post-btn"
                  data-post-id="${post.id}"
                  onclick="editPostClicked(event, ${post.id})"
                  style="position:absolute; top:16px; right:16px; z-index:2;">
                  ØªØ¹Ø¯ÙŠÙ„
                </button>

              `;
          }
          postsHTML += `
        <div class="post-card" onclick="goToPostDetails(${
          post.id
        })" style="cursor:pointer; position:relative;">

          ${buttonContent}

          <div class="d-flex align-items-center mb-2">
            <a href="userProfile.html?id=${
              post.author.id
            }" onclick="event.stopPropagation()" style="text-decoration: none; color: inherit;">
              <img
                src="${post.author.profile_image}"
                class="rounded-circle me-2"
                style="width: 36px; height: 36px"
                alt="${post.author.name}"
                onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'"
              />
              <span class="post-author">${post.author.name}</span>
            </a>
            <span class="post-date ms-2">${post.created_at}</span>
          </div>
          <div class="fw-bold mb-2 post-title">
            ${post.title ? post.title : ""}
          </div>
          <div class="fw-bold mb-2 post-body">
            ${post.body ? post.body : ""}
          </div>
          <div class="tags mb-2">
            ${tagsHTML}
          </div>
          ${
            post.image &&
            typeof post.image === "string" &&
            post.image.trim() !== ""
              ? `<img src="${post.image}" class="post-image" alt="post image" onerror="this.style.display='none'" />`
              : ""
          }
          <span class="comments-toggle" data-comments="0">${
            post.comments_count
          } ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
          <div class="comments-section">
            <form class="add-comment">
              <input type="text" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚..." disabled />
              <button type="submit" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
            </form>
          </div>
        </div>
      `;
        }
        const postsContainer = document.getElementById("post-card-id");
        if (append) {
          postsContainer.innerHTML += postsHTML; // Ø£Ø¶Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙ‚Ø·
        } else {
          postsContainer.innerHTML = postsHTML; // Ø§Ø³ØªØ¨Ø¯Ù„ (Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ÙÙ‚Ø·)
        }
      }

      // ================== Ù†Ù‡Ø§ÙŠØ© Ø±Ø³Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª ==================
      function editPostClicked(event, postId) {
        event.stopPropagation();
        deleteEditingPostId = postId; // Ø®Ø²Ù‘Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ø¨ÙˆØ³Øª Ø§Ù„Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„Ù‡

        const postCard = event.target.closest(".post-card");
        const postBodyDiv = postCard.querySelector(".post-body");
        const postTitleDiv = postCard.querySelector(".post-title");

        const body = postBodyDiv ? postBodyDiv.textContent : "";
        const title = postTitleDiv ? postTitleDiv.textContent : "";
        document.getElementById("edit-post-body").value = body;
        document.getElementById("edit-post-title").value = title;

        const editModal = new bootstrap.Modal(
          document.getElementById("editPostModal")
        );
        editModal.show();
      }

      function deleatPostClicked(event, postId) {
        event.stopPropagation();
        deleteEditingPostId = postId;
        document.getElementById("customDeleteModal").style.display = "flex";
      }
      // ================== ØªÙØ¹ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ==================
      function activateCommentsToggle() {
        document
          .querySelectorAll(".comments-toggle")
          .forEach(function (toggle) {
            toggle.addEventListener("click", function () {
              var section =
                this.parentElement.querySelector(".comments-section");
              section.classList.toggle("active");
            });
          });
      }
      // ================== Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==================
      function main() {
        GetPosts(1, false); // append = false
        activateCommentsToggle();
        // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        document.getElementById("confirmDeleteBtn").onclick = function () {
          if (deleteEditingPostId !== null) {
            let token = localStorage.getItem("token");
            toggelLoading(true);
            axios
              .delete(
                `https://tarmeezacademy.com/api/v1/posts/${deleteEditingPostId}`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                  },
                }
              )
              .then((response) => {
                document.getElementById("customDeleteModal").style.display =
                  "none";
                window.location.reload();
              })
              .catch((error) => {
                console.log(error);
              })
              .finally(() => {
                toggelLoading(false);
              });
          }
        };
        document.getElementById("cancelDeleteBtn").onclick = function () {
          document.getElementById("customDeleteModal").style.display = "none";
        };
      }
      main();
      // ================== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==================
      document
        .getElementById("edit-post-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          let token = localStorage.getItem("token");
          const newBody = document.getElementById("edit-post-body").value;
          const newTitle = document.getElementById("edit-post-title").value;
          const newImage = document.getElementById("edit-post-image").files[0];

          const formData = new FormData();
          formData.append("body", newBody);
          formData.append("title", newTitle);
          formData.append("image", newImage);
          formData.append("_method", "put");
          toggelLoading(true);
          axios
            .post(
              `https://tarmeezacademy.com/api/v1/posts/${deleteEditingPostId}`,
              formData,
              {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              }
            )
            .then((response) => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editPostModal")
              );
              modal.hide();
              GetPosts();
            })
            .finally(() => {
              toggelLoading(false);
            });
        });
      function goToPostDetails(postId) {
        window.location.href = `postDetails.html?postId=${postId}`;
      }
    </script>
    <script src="shareNewPost.js"></script>

    <!-- Scripts at end of body for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="navbar.js"></script>
  </body>
</html>
