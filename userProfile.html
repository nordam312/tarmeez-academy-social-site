<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <title>Tarmeaz Academy - Profile</title>
    <link rel="icon" type="image/png" href="tarmeaz_academy-removebg-preview.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Google Fonts: Tajawal -->
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css?v=2.0" />
    <style>
      body {
        font-family: "Tajawal", sans-serif;
        background: #1C201E;
        margin: 0;
        padding: 0;
      }

      /* Header Banner */
      .profile-banner {
        height: 200px;
        background: linear-gradient(135deg, #0D5B57 0%, #1a7a75 50%, #0D5B57 100%);
        position: relative;
        margin-bottom: 80px;
        box-shadow: 0 4px 20px rgba(13, 91, 87, 0.3);
        overflow: hidden;
      }

      .profile-banner::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: rotateBanner 20s linear infinite;
      }

      @keyframes rotateBanner {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .profile-banner::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 100px;
        background: linear-gradient(to bottom, transparent, #1C201E);
        z-index: 1;
      }

      /* Profile Main Card */
      .profile-main {
        max-width: 900px;
        margin: -100px auto 40px auto;
        background: #242021;
        border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        border: 1px solid #0D5B57;
        padding: 80px 40px 40px 40px;
        text-align: center;
        position: relative;
        z-index: 2;
      }

      .profile-main .profile-img {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 5px solid #0D5B57;
        background: #242021;
        box-shadow: 0 0 40px rgba(13, 91, 87, 0.6);
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: -75px;
        transition: all 0.3s;
      }

      .profile-main .profile-img:hover {
        transform: translateX(-50%) scale(1.05);
        box-shadow: 0 0 50px rgba(13, 91, 87, 0.8);
      }

      .profile-main .profile-name {
        font-size: 2.2rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 8px;
        text-shadow: 0 0 20px rgba(13, 91, 87, 0.5);
      }

      .profile-main .profile-email {
        color: #0D5B57;
        font-size: 1.1rem;
        margin-bottom: 30px;
        font-weight: 600;
      }

      .profile-main .profile-stats {
        display: flex;
        justify-content: center;
        gap: 40px;
        margin: 30px 0;
        flex-wrap: wrap;
      }

      .profile-main .stat-box {
        background: #1C201E;
        border: 2px solid #0D5B57;
        border-radius: 12px;
        padding: 20px 40px;
        text-align: center;
        min-width: 150px;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
      }

      .profile-main .stat-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(13, 91, 87, 0.2), transparent);
        transition: left 0.5s;
      }

      .profile-main .stat-box:hover::before {
        left: 100%;
      }

      .profile-main .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 25px rgba(13, 91, 87, 0.5);
        border-color: #0D5B57;
      }

      .profile-main .stat-box h6 {
        margin: 0 0 8px 0;
        color: #888;
        font-weight: 600;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .profile-main .stat-box span {
        display: block;
        font-size: 2rem;
        color: #0D5B57;
        font-weight: 700;
      }

      .profile-divider {
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, transparent, #0D5B57, transparent);
        margin: 30px auto;
      }

      .posts-header {
        max-width: 900px;
        margin: 0 auto 30px auto;
        text-align: center;
      }

      .posts-header h3 {
        color: #0D5B57;
        font-weight: 700;
        font-size: 1.8rem;
        margin-bottom: 10px;
      }

      .posts-header p {
        color: #888;
        font-size: 1rem;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .profile-banner {
          height: 150px;
          margin-bottom: 60px;
        }

        .profile-main {
          margin: -80px 20px 30px 20px;
          padding: 60px 20px 30px 20px;
        }

        .profile-main .profile-img {
          width: 120px;
          height: 120px;
          top: -60px;
        }

        .profile-main .profile-name {
          font-size: 1.8rem;
        }

        .profile-main .profile-stats {
          gap: 20px;
        }

        .profile-main .stat-box {
          padding: 15px 25px;
          min-width: 120px;
        }

        .posts-header h3 {
          font-size: 1.5rem;
        }
      }

      /* Loading Skeleton */
      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      .skeleton {
        background: linear-gradient(90deg, #242021 25%, #2a2529 50%, #242021 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <!-- النافبار سيتم تحميله تلقائياً عبر navbar.js -->

    <!-- Profile Banner -->
    <div class="profile-banner"></div>

    <!-- معلومات المستخدم -->
    <div class="profile-main">
      <img src="" alt="صورة المستخدم" class="profile-img" id="profile-img" />
      <div class="profile-name">اسم المستخدم</div>
      <div class="profile-email">user@email.com</div>

      <div class="profile-divider"></div>

      <div class="profile-stats">
        <div class="stat-box">
          <h6>📝 المنشورات</h6>
          <span id="posts-count">0</span>
        </div>
        <div class="stat-box">
          <h6>💬 التعليقات</h6>
          <span id="comments-count">0</span>
        </div>
      </div>
    </div>

    <!-- Posts Header -->
    <div class="posts-header">
      <h3>📝 منشورات المستخدم</h3>
      <p>جميع المنشورات والتحديثات</p>
    </div>

    <!-- Posts Section Start -->
    <!-- نموذج إضافة منشور جديد -->
    <div class="container" style="max-width: 900px; margin-bottom: 32px">
      <form id="add-post-form" class="card p-3 mb-4 shadow-sm">
        <div class="mb-2">
          <input
            type="text"
            class="form-control mb-2"
            id="new-post-title"
            placeholder="عنوان المنشور"
            required
          />
          <textarea
            class="form-control mb-2"
            id="new-post-body"
            rows="3"
            placeholder="ماذا تريد أن تكتب؟"
            style="resize: none"
            required
          ></textarea>
          <input
            type="file"
            class="form-control"
            id="new-post-image"
            accept="image/*"
          />
        </div>
        <div class="d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">نشر</button>
        </div>
      </form>
    </div>
    <div id="post-card-id" class="container mt-5" style="max-width: 900px">
      <div class="post-card">
        <!-- <div class="d-flex align-items-center mb-2">
          <img
            src="https://randomuser.me/api/portraits/men/32.jpg"
            class="rounded-circle me-2"
            style="width: 36px; height: 36px"
            alt="محمد أحمد"
            onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'"
          />

          <span class="post-author">محمد أحمد</span>
          <span class="post-date ms-2">قبل دقيقة</span>
        </div>
        <div>هذا أول بوست تجريبي على الموقع! 🚀</div>
        <div class="tags mb-2">
          <span class="badge bg-primary me-1">#تجريب</span>
          <span class="badge bg-primary me-1">#موقع</span>
        </div>
        <img
          src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=600&q=80"
          class="post-image"
          alt="post image"
        />
        <span class="comments-toggle" data-comments="0">2 تعليقات</span>
        <div class="comments-section">
          <div class="comment">
            <span class="comment-author">سارة:</span> رائع جداً 👏
          </div>
          <div class="comment">
            <span class="comment-author">خالد:</span> متحمس أشوف المزيد!
          </div>
          <form class="add-comment">
            <input type="text" placeholder="أضف تعليق..." disabled />
            <button type="submit" disabled>إرسال</button>
          </form>
        </div> -->
      </div>
    </div>

    <div class="modal fade" id="editPostModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="edit-post-form">
            <div class="modal-header">
              <h5 class="modal-title">تعديل البوست</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="edit-post-title" class="form-label">العنوان</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-post-title"
                  rows="4"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="edit-post-body" class="form-label">المحتوى</label>
                <textarea
                  class="form-control"
                  id="edit-post-body"
                  rows="4"
                  style="resize: none"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="edit-post-image" class="form-label">الصورة</label>
                <input
                  type="file"
                  class="form-control"
                  id="edit-post-image"
                  rows="4"
                  style="resize: none"
                  required
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                إلغاء
              </button>
              <button type="submit" class="btn btn-primary">
                حفظ التعديلات
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- نافذة تأكيد مخصصة -->
    <div id="customDeleteModal" class="custom-modal">
      <div class="custom-modal-content">
        <p>هل أنت متأكد أنك تريد حذف هذا المنشور؟</p>
        <button id="confirmDeleteBtn" class="custom-btn confirm">تأكيد</button>
        <button id="cancelDeleteBtn" class="custom-btn cancel">إلغاء</button>
      </div>
    </div>

  <!-- Scripts at end of body for better performance -->
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="navbar.js"></script>
  <script src="shareNewPost.js"></script>

  <script>
    // منع الوصول لصفحة البروفايل بدون تسجيل دخول
    if (!localStorage.getItem("token")) {
      window.location.href = "index.html"; // أو يمكنك توجيههم لصفحة تسجيل الدخول
    }
    // جلب id المستخدم من الرابط
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    const currentUser = JSON.parse(localStorage.getItem("user"));
    const myId = currentUser ? currentUser.id : null;

    // إخفاء نموذج إضافة منشور إذا لم يكن صاحب الصفحة
    if (id != myId) {
      // إخفاء نموذج إضافة منشور
      const form = document.getElementById("add-post-form");
      if (form) form.style.display = "none";

      // إزالة الكلاس active من زر البروفايل في النافبار
      const profileLink = document.getElementById("profile-link");
      if (profileLink) profileLink.classList.remove("active");
    }
    function getUser() {
      toggelLoading(true);
      axios
        .get(`https://tarmeezacademy.com/api/v1/users/${id}`)
        .then((response) => {
          let user = response.data.data;
          setUserDetails(user);
        })
        .catch((error) => {
          console.log(error);
        })
        .finally(() => {
          toggelLoading(false);
        });
    }
    function setUserDetails(user) {
      // تحديث صورة البروفايل
      const img = document.getElementById("profile-img");
      if (user.profile_image) {
        img.src = user.profile_image;
        img.onerror = function () {
          this.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        };
      } else {
        img.src = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
      }
      // تحديث الاسم
      const nameDiv = document.querySelector(".profile-name");
      if (nameDiv && user.name) {
        nameDiv.textContent = user.name;
      }
      // تحديث الإيميل
      const emailDiv = document.querySelector(".profile-email");
      if (emailDiv && user.email) {
        emailDiv.textContent = user.email;
      }
      // تحديث الإحصائيات
      const postsCount = document.getElementById("posts-count");
      const commentsCount = document.getElementById("comments-count");
      if (postsCount) postsCount.textContent = user.posts_count || 0;
      if (commentsCount) commentsCount.textContent = user.comments_count || 0;
    }

    // ================== جلب البوستات من الـ API ==================
    function GetPosts() {
      toggelLoading(true);
      axios
        .get(`https://tarmeezacademy.com/api/v1/users/${id}/posts`)
        .then(function (response) {
          let posts = response.data.data;
          SetPosts(posts);
        })
        .catch(function (error) {
          console.log(error);
        })
        .finally(() => {
          toggelLoading(false);
        });
    }

    // ================== نهاية جلب البوستات ==================

    // ================== رسم جميع البوستات ==================

    function SetPosts(posts) {
      let postsHTML = "";

      // إذا لم يكن هناك منشورات
      if (!posts || posts.length === 0) {
        postsHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #888; grid-column: 1 / -1;">
            <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.5;">📭</div>
            <h3 style="color: #0D5B57; margin-bottom: 10px;">لا توجد منشورات بعد</h3>
            <p>لم يقم هذا المستخدم بنشر أي محتوى حتى الآن</p>
          </div>
        `;
        document.getElementById("post-card-id").innerHTML = postsHTML;
        return;
      }

      for (const post of posts) {
        let tagsHTML = "";
        if (post.tags && post.tags.length > 0) {
          for (let i = 0; i < post.tags.length; i++) {
            tagsHTML += `<span class="badge bg-primary me-1">#${post.tags[i].name}</span>`;
          }
        }
        let user = JSON.parse(localStorage.getItem("user"));
        let userId = null;
        if (user) {
          userId = user.id;
        }
        let isMyPost = user != null && post.author.id === userId;
        let buttonContent = ``;

        if (isMyPost) {
          buttonContent = `
                <button class="btn btn-outline-danger btn-sm edit-post-btn"
                  data-post-id="${post.id}"
                  onclick="deleatPostClicked(event, ${post.id})"
                  style="position:absolute; top:16px; right:71px; z-index:2;">
                  حذف
                </button>
                <button class="btn btn-outline-primary btn-sm edit-post-btn"
                  data-post-id="${post.id}"
                  onclick="editPostClicked(event, ${post.id})"
                  style="position:absolute; top:16px; right:16px; z-index:2;">
                  تعديل
                </button>

              `;
        }
        postsHTML += `
        <div class="post-card" onclick="goToPostDetails(${
          post.id
        })" style="cursor:pointer; position:relative;">
        ${buttonContent}
          <div class="d-flex align-items-center mb-2">
            <img
              src="${post.author.profile_image}"
              class="rounded-circle me-2"
              style="width: 36px; height: 36px"
              alt="${post.author.name}"
              onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'"
            />
            <span class="post-author">${post.author.name}</span>
            <span class="post-date ms-2">${post.created_at}</span>
          </div>
          <div class="fw-bold mb-2 post-title">
            ${post.title ? post.title : ""}
          </div>
          <div class="fw-bold mb-2 post-body">
            ${post.body ? post.body : ""}
          </div>
          <div class="tags mb-2">
            ${tagsHTML}
          </div>
          ${
            post.image &&
            typeof post.image === "string" &&
            post.image.trim() !== ""
              ? `<img src="${post.image}" class="post-image" alt="post image" onerror="this.style.display='none'" />`
              : ""
          }
          <span class="comments-toggle" data-comments="0">${
            post.comments_count
          } تعليقات</span>
          <div class="comments-section">
            <form class="add-comment">
              <input type="text" placeholder="أضف تعليق..." disabled />
              <button type="submit" disabled>إرسال</button>
            </form>
          </div>
        </div>
      `;
      }
      const postsContainer = document.getElementById("post-card-id");
      postsContainer.innerHTML = postsHTML;
    }
    function goToPostDetails(postId) {
      window.location.href = `postDetails.html?postId=${postId}`;
    }
    function deleatPostClicked(event, postId) {
      event.stopPropagation();
      deleteEditingPostId = postId;
      document.getElementById("customDeleteModal").style.display = "flex";
    }
    function editPostClicked(event, postId) {
      event.stopPropagation();
      deleteEditingPostId = postId; // خزّن معرف البوست الجاري تعديله

      const postCard = event.target.closest(".post-card");
      const postBodyDiv = postCard.querySelector(".post-body");
      const postTitleDiv = postCard.querySelector(".post-title");

      const body = postBodyDiv ? postBodyDiv.textContent : "";
      const title = postTitleDiv ? postTitleDiv.textContent : "";
      document.getElementById("edit-post-body").value = body;
      document.getElementById("edit-post-title").value = title;

      const editModal = new bootstrap.Modal(
        document.getElementById("editPostModal")
      );
      editModal.show();
    }

    function toggelLoading(show = true) {
      const overlay = document.getElementById("global-loading-overlay");
      if (!overlay) return;
      if (show) {
        overlay.style.display = "flex";
      } else {
        overlay.style.display = "none";
      }
    }

    getUser();
    GetPosts();
    document.getElementById("confirmDeleteBtn").onclick = function () {
      if (deleteEditingPostId !== null) {
        let token = localStorage.getItem("token");
        toggelLoading(true);
        axios
          .delete(
            `https://tarmeezacademy.com/api/v1/posts/${deleteEditingPostId}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          )
          .then((response) => {
            document.getElementById("customDeleteModal").style.display = "none";
            window.location.reload();
          })
          .catch((error) => {
            console.log(error);
          })
          .finally(() => {
            toggelLoading(false);
          });
      }
    };
    document.getElementById("cancelDeleteBtn").onclick = function () {
      document.getElementById("customDeleteModal").style.display = "none";
    };
    document
      .getElementById("edit-post-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        let token = localStorage.getItem("token");
        const newBody = document.getElementById("edit-post-body").value;
        const newTitle = document.getElementById("edit-post-title").value;
        const newImage = document.getElementById("edit-post-image").files[0];

        const formData = new FormData();
        formData.append("body", newBody);
        formData.append("title", newTitle);
        formData.append("image", newImage);
        formData.append("_method", "put");
        toggelLoading(true);
        axios
          .post(
            `https://tarmeezacademy.com/api/v1/posts/${deleteEditingPostId}`,
            formData,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          )
          .then((response) => {
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("editPostModal")
            );
            modal.hide();
            GetPosts();
          })
          .finally(() => {
            toggelLoading(false);
          });
      });
  </script>
</html>
